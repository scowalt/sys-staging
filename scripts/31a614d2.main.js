window.SysViewModel=function(){"use strict";function a(){var a=this,b={Waiting:"default",Ready:"success",Compiling:"primary",Cancelled:"default",Success:"success",Warnings:"warning",Failed:"danger"},c={Stopped:"danger",Booting:"warning",Running:"success",Paused:"default"};a.challengeDoc=ko.observable(),a.editorText=ko.observable(),a.gccErrorCount=ko.observable(0),a.gccWarningCount=ko.observable(0),a.gccOptions=ko.observable(),a.gccOptsError=ko.observable(""),a.programArgs=ko.observable(),a.lastGccOutput=ko.observable(""),a.compileStatus=ko.observable("Waiting"),a.compileStatusClass=ko.pureComputed(function(){return"label label-"+b[a.compileStatus()]}),a.compileBtnEnable=ko.pureComputed(function(){return!("Waiting"===a.compileStatus()||"Compiling"===a.compileStatus())}),a.compileBtnTooltip=ko.observable(),a.errorWarningLabel=ko.pureComputed(function(){var b=a.gccErrorCount(),c=a.gccWarningCount(),d="";return d+=b?b+" error"+(b>1?"s ":" "):"",d+=c?c+" warning"+(c>1?"s":""):"",d&&(d+="â€¦"),d}),a.showErrorWarningLabel=ko.pureComputed(function(){return"Warnings"===a.compileStatus()||"Failed"===a.compileStatus()}),a.vmState=ko.observable("Stopped"),a.vmStateClass=ko.pureComputed(function(){return"label label-"+c[a.vmState()]}),a.vmMips=ko.observable(0),a.availableAceThemes=ko.observableArray(["monokai","terminal","tomorrow","xcode"]),a.aceTheme=ko.observable(a.availableAceThemes()[0]),a.aceFontSize=ko.observable(),a.ttyContainer=$("#tty-container"),a.ttyFullScreen=ko.observable(!1),a.ttyFullScreen.subscribe(function(b){a.ttyContainer.appendTo(b?"body":"#tty-pane")}),a.ttyToggleBtnClass=ko.pureComputed(function(){return"glyphicon "+(a.ttyFullScreen()?"glyphicon-resize-small":"glyphicon-resize-full")}),a.openManPageTabs=ko.observableArray(),a.closeManPageTab=function(b){var c,d=a.openManPageTabs.indexOf(b);c=d>=1?"#man-page-tab-"+(d-1):"#man-pages-index",$('a[href="'+c+'"]').parent().addClass("active"),$(c).addClass("active"),a.openManPageTabs.splice(d,1)}}return a.prototype.setState=function(a){a=a||{},a.challengeDoc&&this.challengeDoc(a.challengeDoc),a.gccOptions&&this.gccOptions(a.gccOptions),a.programArgs&&this.programArgs(a.programArgs),a.editorText&&this.editorText(a.editorText)},a}(),window.Jor1kGUI=function(){"use strict";function a(a){this.ReceiveChar=function(b){a.lastMouseDownTarget!==a.fbcanvas&&a.sendToWorker("tty0",b)}}function b(b,c,d){this.urls=c,this.worker=new Worker("jor1k/js/worker/worker.js"),this.worker.onmessage=this.onMessage.bind(this),this.worker.onerror=function(a){console.log("Error at "+a.filename+":"+a.lineno+": "+a.message)},this.sendToWorker=function(a,b){this.worker.postMessage({command:a,data:b})},this.reset=function(){this.stop=!1,this.userpaused=!1,this.executepending=!1,this.sendToWorker("Reset"),this.sendToWorker("LoadAndStart",this.urls),this.term.PauseBlink(!1)},this.pause=function(a){a=!!a,a!==this.userpaused&&(this.userpaused=a,!this.userpaused&&this.executepending&&(this.executepending=!1,this.sendToWorker("execute",0)),this.term.PauseBlink(a))},this.terminalcanvas=document.getElementById(b),this.term=new Terminal(24,80,b),this.terminput=new TerminalInput(new a(this)),this.ignoreKeys=function(){return this.lastMouseDownTarget!==this.terminalcanvas};var e=function(a){this.lastMouseDownTarget=a.target}.bind(this);sysViewModel.ttyFullScreen.subscribe(function(){this.lastMouseDownTarget=this.terminalcanvas},this),document.addEventListener?document.addEventListener("mousedown",e,!1):window.onmousedown=e,document.onkeypress=function(a){return this.ignoreKeys()?!0:(this.sendToWorker("keypress",{keyCode:a.keyCode,charCode:a.charCode}),this.terminput.OnKeyPress(a))}.bind(this),document.onkeydown=function(a){return this.ignoreKeys()?!0:(this.sendToWorker("keydown",{keyCode:a.keyCode,charCode:a.charCode}),this.terminput.OnKeyDown(a))}.bind(this),document.onkeyup=function(a){return this.ignoreKeys()?!0:(this.sendToWorker("keyup",{keyCode:a.keyCode,charCode:a.charCode}),this.terminput.OnKeyUp(a))}.bind(this),this.ethernet=new Ethernet(d),this.ethernet.onmessage=function(a){this.sendToWorker("ethmac",a.data)}.bind(this),this.reset(),window.setInterval(function(){this.sendToWorker("GetIPS",0)}.bind(this),1e3)}return b.prototype.onMessage=function(a){if(!this.stop)switch(a.data.command){case"execute":this.userpaused?this.executepending=!0:(this.executepending=!1,this.sendToWorker("execute",0));break;case"ethmac":this.ethernet.SendFrame(a.data.data);break;case"tty0":this.term.PutChar(a.data.data);break;case"Stop":console.log("Received stop signal"),this.stop=!0;break;case"GetIPS":sysViewModel.vmMips(this.userpaused?0:Math.floor(a.data.data/1e5)/10);break;case"Debug":console.log(a.data.data)}},b}(),window.ExpectTTY=function(){"use strict";function a(a,b,c){this.output="",this.callback=c,this.expect=b,this.sys=a,this.found=!1,this.expectPutCharListener=function(a,b){this.output=this.output.substr(this.output.length===this.expect.length?1:0)+b.detail.character,this.output===this.expect&&(this._cleanup(),this.callback(!0))}.bind(this),this.sys.addListener("putchar",this.expectPutCharListener)}return a.prototype._cleanup=function(){this.sys.removeListener("putchar",this.expectPutCharListener)},a.prototype.cancel=function(){this._cleanup(),this.callback(!1)},a}(),window.Editor=function(){"use strict";function a(a){var b=this;b.viewModel=sysViewModel,b.editorDivId=a,b.aceEditor=ace.edit(a),b.setTheme(b.viewModel.aceTheme()),b.viewModel.aceFontSize(12),b.setMode("c_cpp"),b.aceEditor.getSession().setTabSize(4),b.aceEditor.getSession().setUseSoftTabs(!0),b.backgroundAutoIndent=!0,b.viewModel.aceTheme.subscribe(function(){b.setTheme(b.viewModel.aceTheme())}),b.viewModel.aceFontSize.subscribe(function(){b.setFontSize(b.viewModel.aceFontSize()+"px")}),b.viewModel.editorText.subscribe(function(){b.setText(b.viewModel.editorText())}),b.aceEditor.on("change",function(){b.backgroundAutoIndent&&(window.clearTimeout(b.reIndentTimer),b.reIndenting||(b.reIndentTimer=window.setTimeout(b.autoIndentCode.bind(b),500)))});var c=$("#editor-settings-btn");c.popover({title:function(){return"Editor settings"},content:function(){return $("#editor-settings-popover").html()}}),c.on("shown.bs.popover",function(){$("#editor-autoindent-checkbox").prop("checked",b.backgroundAutoIndent),$("#ace-highlight-active-lines-checkbox").prop("checked",b.aceEditor.getHighlightActiveLine()),$("#ace-show-invisibles-checkbox").prop("checked",b.aceEditor.getShowInvisibles())});var d=$("body");d.on("change","#editor-autoindent-checkbox",function(){b.backgroundAutoIndent=this.checked}),d.on("change","#ace-highlight-active-lines-checkbox",function(){b.aceEditor.setHighlightActiveLine(this.checked)}),d.on("change","#ace-show-invisibles-checkbox",function(){b.aceEditor.setShowInvisibles(this.checked)})}return a.prototype.setTheme=function(a){this.aceEditor.setTheme("ace/theme/"+a)},a.prototype.getText=function(){return this.aceEditor.getSession().getValue()},a.prototype.setText=function(a){return this.aceEditor.getSession().setValue(a)},a.prototype.setFontSize=function(a){document.getElementById(this.editorDivId).style.fontSize=a},a.prototype.setMode=function(a){this.aceEditor.getSession().setMode("ace/mode/"+a)},a.prototype.setAnnotations=function(a){this.aceEditor.getSession().setAnnotations(a)},a.prototype.resize=function(a){var b=this;a=a||200,window.setTimeout(function(){$("#"+b.editorDivId).height($("#code-container").height()-$("#editor-tabs-bar").height()-$("#editor-opts-container").height()-$("#compile-opts-container").height()-2),b.aceEditor.resize()},a)},a.prototype.addKeyboardCommand=function(a,b,c,d){d=d||!0,this.aceEditor.commands.addCommand({name:a,bindKey:b,exec:c,readOnly:d})},a.prototype.autoIndentCode=function(){var a,b,c,d,e=this.aceEditor,f=e.getCursorPosition(),g=e.getSession(),h=g.getDocument(),i=g.getMode(),j=g.getLength();for(this.reIndenting=!0,a=0;j>a;a++)0!==a&&(b=i.getNextLineIndent(g.getState(a-1),g.getLine(a-1),g.getTabString()),c=g.getLine(a),d=/^\s*/.exec(c)[0],d!==b&&(c=b+c.trim()),h.insertLines(a,[c]),h.removeLines(a+1,a+1),i.autoOutdent(g.getState(a),g,a));e.moveCursorToPosition(f),e.clearSelection(),this.reIndenting=!1},a}(),window.GccOutputParser=function(){"use strict";function a(){}var b=/(program\.c|gcc|cc1|collect2):\s*(.+)\s*:\s*(.+)\s*/,c=/(\d+):(\d+):\s*(.+)/,d=/\s*(.+)\s*:\s*(.+)\s*/,e={"program.c":"compile",gcc:"gcc",cc1:"gcc",collect2:"linker"};return a.prototype.parse=function(a){var f,g,h,i,j,k,l,m=[];return a.split("\n").forEach(function(a){f=b.exec(a),f&&(g=c.exec(f[2]),g?(i=g[1],j=g[2],h=d.exec(g[3]),h?(k=h[1],l=h[2]+": "+f[3]):(k=g[3],l=f[3])):(i=j=0,h=d.exec(f[2]),h?(k=h[1],l=h[2]+": "+f[3]):(k=f[2],l=f[3])),m.push({row:i,column:j,type:e[f[1]],gccErrorType:k,text:l}))}),m},a}(),window.LiveEdit=function(){"use strict";function a(a,b){this.runtime=b,this.editor=a,this.viewModel=sysViewModel;var c=function(){var a=this.runtime.ready();this.viewModel.vmState(a?"Running":"Booting"),this.viewModel.compileStatus(a?"Ready":"Waiting")}.bind(this);c(),this.runtime.addListener("ready",function(){c()}.bind(this))}return a.prototype.escapeHtml=function(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},a.prototype.processGccCompletion=function(a){if(this.viewModel.gccErrorCount(0),this.viewModel.gccWarningCount(0),!a)return void this.viewModel.compileStatus("Cancelled");this.runtime.sendKeys("clear\n");var b=[],c=[];a.annotations.forEach(function(a){a.isGccOptsError?c.push(a):b.push(a)}),this.editor.setAnnotations(b),this.viewModel.lastGccOutput(a.gccOutput),this.viewModel.gccErrorCount(a.stats.error),this.viewModel.gccWarningCount(a.stats.warning),this.viewModel.gccOptsError(c.map(function(a){return a.text}).join("\n")),0===a.exitCode?(this.viewModel.compileStatus(a.stats.warning>0?"Warning":"Success"),this.runtime.startProgram("program",this.viewModel.programArgs())):this.viewModel.compileStatus("Failed")},a.prototype.runCode=function(a,b){if(!(0===a.length||a.indexOf("")>=0||a.indexOf("")>=0)){var c=this.processGccCompletion.bind(this);this.viewModel.compileStatus("Compiling"),this.runtime.startGccCompile(a,b,c)}},a}(),window.SysRuntime=function(){"use strict";function a(){this.bootFinished=!1,this.listeners={},this.ttyState=this.BOOT,this.ttyOutput="",this.captureOutput=!1,this.compileTicket=0,this.gccOutputCaptureRe=/###GCC_COMPILE###\s*([\S\s]*?)\s*###GCC_COMPILE_FINISHED###/,this.gccExitCodeCaptureRe=/GCC_EXIT_CODE: (\d+)/,this.putCharListener=function(a){this.captureOutput&&(this.ttyOutput+=a.detail.character),this.notifyListeners("putchar",a)}.bind(this);var a=function(a){this.bootFinished=a,a&&this.notifyListeners("ready",!0)}.bind(this),b=function(b){b&&this.sendKeys("\nstty -clocal crtscts -ixoff\ngcc hello.c;echo boot2ready-$?;rm a.out\n","boot2ready-0",a)}.bind(this);return document.addEventListener("jor1k_terminal_put_char",this.putCharListener,!1),this.jor1kgui=new Jor1kGUI("tty",["../../bin/vmlinux.bin.bz2","../../../jor1k_hd_images/hdgcc-mod.bz2"],""),this.sendKeys("","root login on 'console'",b),this}a.prototype.ready=function(){return this.bootFinished},a.prototype.startGccCompile=function(a,b,c){if(!this.bootFinished)return 0;this.expecting&&this.expecting.cancel(),this.ttyOutput="",this.captureOutput=!0,++this.compileTicket;var d=function(a){var b=null;if(this.expecting=void 0,a){this.captureOutput=!1;var d=this.gccOutputCaptureRe.exec(this.ttyOutput),e=d[1],f=parseInt(this.gccExitCodeCaptureRe.exec(e)[1]);this.ttyOutput="";var g={error:0,warning:0,info:0},h=this.getErrorAnnotations(e);h.forEach(function(a){g[a.type]+=1}),b={exitCode:f,stats:g,annotations:h,gccOutput:e}}c(b)}.bind(this);this.sendKeys("\ncd ~;rm program.c program 2>/dev/null\n"),this.sendTextFile("program.c",a);var e="echo \\#\\#\\#GCC_COMPILE\\#\\#\\#;clear;gcc "+b+" program.c -o program; echo GCC_EXIT_CODE: $?; echo \\#\\#\\#GCC_COMPILE_FINISHED\\#\\#\\#"+this.compileTicket+".;clear\n";return this.expecting=this.sendKeys(e,"GCC_COMPILE_FINISHED###"+this.compileTicket+".",d),this.compileTicket},a.prototype.getErrorAnnotations=function(a){var b=(new GccOutputParser).parse(a);return b.map(function(a){var b;return b=-1!==a.gccErrorType.toLowerCase().indexOf("error")?"error":-1!==a.gccErrorType.toLowerCase().indexOf("warning")?"warning":"info",{row:a.row-1,col:a.col,isGccOptsError:"gcc"===a.type,type:b,text:a.text}})},a.prototype.startProgram=function(a,b){a&&("/"!==a[0]&&"."!==a[0]&&(a="./"+a.replace(" ","\\ ")),b=b.replace("\\","\\\\").replace("\n","\\n"),this.sendKeys("\n"+a+" "+b+"\n"))},a.prototype.sendTextFile=function(a,b){this.sendKeys("\nstty raw\ndd ibs=1 of="+a+" count="+b.length+"\n"+b+"\nstty -raw\n")},a.prototype.addListener=function(a,b){var c=this.listeners[a];c?c.push(b):this.listeners[a]=[b]},a.prototype.removeListener=function(a,b){var c=this.listeners[a];this.listeners[a]=c.filter(function(a){return a!==b})},a.prototype.notifyListeners=function(a,b){var c=this.listeners[a];if(c){c=c.slice();for(var d=0;c&&d<c.length;d++)c[d](this,b)}},a.prototype.sendKeys=function(a,b,c,d){var e="tty0",f=null;this.jor1kgui.pause(!1),b&&(f=new ExpectTTY(this,b,c,d));for(var g=0;g<a.length;g++)this.jor1kgui.sendToWorker(e,a.charCodeAt(g)>>>0);return f};var b;return{getInstance:function(){return b||(b=new a,b.constructor=null),b}}}(),window.Router=function(){"use strict";function a(){return Sammy(function(){this.get("/",function(){$.get("robots.txt",function(a){console.log(a),window.alert(a)})})})}var b;return{getInstance:function(){return b||(b=new a,b.constructor=null),b}}}(),$(document).ready(function(){"use strict";var a=function(){var a=$("#layout").layout({livePaneResizing:!0,north__paneSelector:"#navbar-container",center__paneSelector:"#code-container",east__paneSelector:"#doc-tty-container",south__paneSelector:"#footer-container",center__minWidth:700,east__size:"50%",spacing_open:2,north__resizable:!1,north__size:33,north__spacing_open:0,north__spacing_closed:0,north__showOverflowOnHover:!0,south__resizable:!1,south__size:29,south__spacing_open:0}),b=a.panes.east.layout({livePaneResizing:!0,spacing_open:2,north__paneSelector:"#doc-container",center__paneSelector:"#tty-pane",north__size:"25%"});return{mainLayout:a,ttyLayout:b}};window.sysViewModel=new SysViewModel;var b=new Editor("code"),c=new LiveEdit(b,SysRuntime.getInstance()),d=[{token:"accept",display:"accept(2)",url:"http://man7.org/linux/man-pages/man2/accept.2.html"},{token:"printf",display:"printf(3)",url:"http://man7.org/linux/man-pages/man3/printf.3.html"},{token:"write",display:"write(2)",url:"http://man7.org/linux/man-pages/man2/write.2.html"},{token:"select",display:"select(2)",url:"http://man7.org/linux/man-pages/man2/select.2.html"}],e=function(a){return{tabName:a.display,tabHtml:'<iframe style="width: 100%; height: 100%" src="'+a.url+'"></iframe>'}};d.slice(0,0).forEach(function(a){window.sysViewModel.openManPageTabs.push(e(a))});var f=function(){window.setTimeout(function(){$(".tab-content").height($("#code-container").height()-$("#editor-tabs-bar").height()-5)},500)};$(window).resize(function(){b.resize(500),f()}),$('a[data-toggle="tab"]').on("shown.bs.tab",function(a){"#editor-container"===$(a.target).attr("href")?b.resize():f()});var g={win:"Ctrl-Return",mac:"Command-Return"},h=(navigator.platform.match(/mac|win|linux/i)||["other"])[0].toLowerCase(),i="Compile and Run ("+("mac"===h?g.mac.replace("Command","âŒ˜"):g.win)+" in code editor)";window.sysViewModel.compileBtnTooltip(i);var j=function(){var a=b.getText(),d=window.sysViewModel.gccOptions();c.runCode(a,d)};$("#compile-btn").click(function(){j()}),b.addKeyboardCommand("compileAndRunShortcut",g,j),$("[data-toggle=tooltip]").tooltip(),$("[data-toggle=popover]").popover().click(function(a){a.preventDefault()}),$("#editor-opts-container").find("form").submit(function(a){a.preventDefault()}),$("#download-file-btn").click(function(){var a=b.getText(),c=new Blob([a],{type:"text/plain;charset=utf-8"});saveAs(c,"program.c")}),$("#autoindent-code-btn").click(function(){b.autoIndentCode()});var k=function(){var a={};a.challengeDoc=a.challengeDoc||{title:"Welcome",instructions:"Welcome to this tiny but fast linux virtual machine. Currently only Chrome is known to work. Other browsers will be supported in the future."},a.gccOptions=a.gccOptions||"-lm -Wall -fmax-errors=10 -Wextra",a.programArgs=a.programArgs||"",a.editorText=a.editorText||'/*Write your C code here*/\n#include <stdio.h>\n\nint main() {\n    printf("Hello world!\\n");\n    return 0;\n}\n',window.sysViewModel.setState(a)};k(),ko.applyBindings(window.sysViewModel),Router.getInstance().run(),a(),$(window).trigger("resize")});
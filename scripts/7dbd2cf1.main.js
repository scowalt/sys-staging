window.Jor1kGUI=function(a,b,c){"use strict";function d(a){this.ReceiveChar=function(b){a.lastMouseDownTarget!==a.fbcanvas&&a.sendToWorker("tty0",b)}}function e(e,f,g,h,i){this.urls=h,this.worker=new Worker("jor1k/js/worker/worker.js"),this.worker.onmessage=this.onMessage.bind(this),this.worker.onerror=function(a){console.log("Error at "+a.filename+":"+a.lineno+": "+a.message)},this.sendToWorker=function(a,b){this.worker.postMessage({command:a,data:b})},this.reset=function(){this.stop=!1,this.userpaused=!1,this.executepending=!1,this.sendToWorker("Reset"),this.sendToWorker("LoadAndStart",this.urls),this.term.PauseBlink(!1)},this.pause=function(a){a=!!a,a!==this.userpaused&&(this.userpaused=a,!this.userpaused&&this.executepending&&(this.executepending=!1,this.sendToWorker("execute",0)),this.term.PauseBlink(a))},this.terminalcanvas=document.getElementById(e),this.term=new a(24,80,e),this.terminput=new b(new d(this)),this.ignoreKeys=function(){return this.lastMouseDownTarget!==this.terminalcanvas};var j=function(a){this.lastMouseDownTarget=a.target}.bind(this);document.addEventListener?document.addEventListener("mousedown",j,!1):window.onmousedown=j,document.onkeypress=function(a){return this.ignoreKeys()?!0:(this.sendToWorker("keypress",{keyCode:a.keyCode,charCode:a.charCode}),this.terminput.OnKeyPress(a))}.bind(this),document.onkeydown=function(a){return this.ignoreKeys()?!0:(this.sendToWorker("keydown",{keyCode:a.keyCode,charCode:a.charCode}),this.terminput.OnKeyDown(a))}.bind(this),document.onkeyup=function(a){return this.ignoreKeys()?!0:(this.sendToWorker("keyup",{keyCode:a.keyCode,charCode:a.charCode}),this.terminput.OnKeyUp(a))}.bind(this),this.ethernet=new c(i),this.ethernet.onmessage=function(a){this.sendToWorker("ethmac",a.data)}.bind(this),this.reset()}return e.prototype.onMessage=function(a){if(!this.stop)switch(a.data.command){case"execute":this.userpaused?this.executepending=!0:(this.executepending=!1,this.sendToWorker("execute",0));break;case"ethmac":this.ethernet.SendFrame(a.data.data);break;case"tty0":this.term.PutChar(a.data.data);break;case"Stop":console.log("Received stop signal"),this.stop=!0;break;case"Debug":console.log(a.data.data)}},e}(Terminal,TerminalInput,Ethernet),window.ExpectTTY=function(){"use strict";function a(a,b,c){this.output="",this.callback=c,this.expect=b,this.sys=a,this.found=!1,this.expectPutCharListener=function(a,b){this.output=this.output.substr(this.output.length===this.expect.length?1:0)+b.detail.character,this.output===this.expect&&(this._cleanup(),this.callback(!0))}.bind(this),this.sys.addListener("putchar",this.expectPutCharListener)}return a.prototype._cleanup=function(){this.sys.removeListener("putchar",this.expectPutCharListener)},a.prototype.cancel=function(){this._cleanup(),this.callback(!1)},a}(),window.LiveEdit=function(a){"use strict";function b(b,c){this.runtime=c,this.ace=a.edit(b),this.ace.setTheme("ace/theme/monokai"),this.ace.getSession().setMode("ace/mode/c_cpp"),this.compileBtn=document.getElementById("compile-btn");var d=function(){var a=this.runtime.ready();this.compileBtn.disabled=!a,this.setHtml("gcc-compile-status",a?"Ready":"VM booting"),this.setHtml("vm-state",a?"Ready":"Booting"),this.getElement("gcc-compile-status").className=a?"label label-success":"label label-warning",this.getElement("vm-state").className=a?"label label-success":"label label-warning"}.bind(this);d(),this.runtime.addListener("ready",function(){d()}.bind(this))}return b.prototype.getElement=function(a){return document.getElementById(a)},b.prototype.setHtml=function(a,b){var c=this.getElement(a);return c.innerHTML=b,c},b.prototype.escapeHtml=function(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},b.prototype.processGccCompletion=function(a){var b='<span onclick="alert(globalLastGccOutput); return false;">SUCCESSFUL WITH WARNINGS</span>',c='<span onclick="alert(globalLastGccOutput); return false;">FAILED</span>';if(this.setHtml("gcc-error-count",""),this.setHtml("gcc-warning-count",""),!a)return this.setHtml("gcc-compile-status","Cancelled"),void(this.getElement("gcc-compile-status").className="label label-default");if(this.runtime.sendKeys("clear\n"),this.ace.getSession().setAnnotations(a.annotations),window.globalLastGccOutput=a.gccOutput,this.setHtml("gcc-error-count",a.stats.error.toString()),this.setHtml("gcc-warning-count",a.stats.warning.toString()),0===a.exitCode){var d=this.getElement("cmdline").value,e=a.stats.warning>0;this.setHtml("gcc-compile-status",e?b:"Success"),this.getElement("gcc-compile-status").className=e?"label label-warning":"label label-success",this.runtime.startProgram("program",d)}else this.setHtml("gcc-compile-status",c),this.getElement("gcc-compile-status").className="label label-danger";this.compileBtn.disabled=!1},b.prototype.getCodeText=function(){return this.ace.getSession().getValue()},b.prototype.runCode=function(a,b){if(!(0===a.length||a.indexOf("")>=0||a.indexOf("")>=0)){var c=this.processGccCompletion.bind(this);this.compileBtn.disabled=!0,this.setHtml("gcc-compile-status","Compiling"),this.getElement("gcc-compile-status").className="label label-warning",this.runtime.startGccCompile(a,b,c)}},b.prototype.setTheme=function(a){this.ace.setTheme("ace/theme/"+a)},b}(ace),window.SysRuntime=function(a){"use strict";function b(){this.bootFinished=!1,this.listeners={},this.ttyState=this.BOOT,this.ttyOutput="",this.captureOutput=!1,this.compileTicket=0,this.gccOutputCaptureRe=/###GCC_COMPILE###\s*([\S\s]*?)\s*###GCC_COMPILE_FINISHED###/,this.gccExitCodeCaptureRe=/GCC_EXIT_CODE: (\d+)/,this.putCharListener=function(a){this.captureOutput&&(this.ttyOutput+=a.detail.character),this.notifyListeners("putchar",a)}.bind(this);var a=function(a){this.bootFinished=a,a&&this.notifyListeners("ready",!0)}.bind(this),b=function(b){b&&this.sendKeys("\nstty -clocal crtscts -ixoff\ngcc hello.c;echo boot2ready-$?\n","boot2ready-0",a)}.bind(this);return document.addEventListener("jor1k_terminal_put_char",this.putCharListener,!1),this.jor1kgui=new Jor1kGUI("tty","fb","stats",["../../bin/vmlinux.bin.bz2","../../../jor1k_hd_images/hdgcc-mod.bz2"],""),this.sendKeys("","root login on 'console'",b),this}b.prototype.ready=function(){return this.bootFinished},b.prototype.startGccCompile=function(a,b,c){if(!this.bootFinished)return 0;this.expecting&&this.expecting.cancel(),this.ttyOutput="",this.captureOutput=!0,++this.compileTicket;var d=function(a){var b=null;if(this.expecting=void 0,a){this.captureOutput=!1;var d=this.gccOutputCaptureRe.exec(this.ttyOutput),e=d[1],f=parseInt(this.gccExitCodeCaptureRe.exec(e)[1]);this.ttyOutput="";var g={error:0,warning:0,info:0},h=this.getErrorAnnotations(e);h.forEach(function(a){g[a.type]+=1}),b={exitCode:f,stats:g,annotations:h,gccOutput:e}}c(b)}.bind(this);this.sendKeys("\ncd ~;rm program.c program 2>/dev/null\n"),this.sendTextFile("program.c",a);var e="echo \\#\\#\\#GCC_COMPILE\\#\\#\\#;clear;gcc "+b+" program.c -o program; echo GCC_EXIT_CODE: $?; echo \\#\\#\\#GCC_COMPILE_FINISHED\\#\\#\\#"+this.compileTicket+".;clear\n";return this.expecting=this.sendKeys(e,"GCC_COMPILE_FINISHED###"+this.compileTicket+".",d),this.compileTicket},b.prototype.getErrorAnnotations=function(a){var b,c,d,e,f,g,h,i,j=/(?:program\.c|gcc|collect2):\s*(.+)\s*:\s*(.+)\s*/,k=/(\d+):(\d+):\s*(.+)/,l=/\s*(.+)\s*:\s*(.+)\s*/,m=[];return a.split("\n").forEach(function(a){b=j.exec(a),b&&(c=k.exec(b[1]),c?(e=c[1]-1,f=c[2],d=l.exec(c[3]),d?(g=d[1],i=d[2]+": "+b[2]):(g=c[3],i=b[2])):(e=f=0,d=l.exec(b[1]),d?(g=d[1],i=d[2]+": "+b[2]):(g=b[1],i=b[2])),h=-1!==g.toLowerCase().indexOf("error")?"error":-1!==g.toLowerCase().indexOf("warning")?"warning":"info",m.push({row:e,column:f,type:h,text:i}))}),m},b.prototype.startProgram=function(a,b){a&&("/"!==a[0]&&"."!==a[0]&&(a="./"+a.replace(" ","\\ ")),b=b.replace("\\","\\\\").replace("\n","\\n"),this.sendKeys("\n"+a+" "+b+"\n"))},b.prototype.sendTextFile=function(a,b){this.sendKeys("\nstty raw\ndd ibs=1 of="+a+" count="+b.length+"\n"+b+"\nstty -raw\n")},b.prototype.addListener=function(a,b){var c=this.listeners[a];c?c.push(b):this.listeners[a]=[b]},b.prototype.removeListener=function(a,b){var c=this.listeners[a];this.listeners[a]=c.filter(function(a){return a!==b})},b.prototype.notifyListeners=function(a,b){var c=this.listeners[a];if(c){c=c.slice();for(var d=0;c&&d<c.length;d++)c[d](this,b)}},b.prototype.sendKeys=function(b,c,d,e){var f="tty0",g=null;this.jor1kgui.pause(!1),c&&(g=new a(this,c,d,e));for(var h=0;h<b.length;h++)this.jor1kgui.sendToWorker(f,b.charCodeAt(h)>>>0);return g};var c;return{getInstance:function(){return c||(c=new b,c.constructor=null),c}}}(ExpectTTY),window.compileMain=function(a,b){"use strict";var c;window.globalLastGccOutput="";var d=function(){var a=c.getCodeText(),b=c.getElement("gccoptions").value;return c.runCode(a,b),!1},e=function(a){c.setTheme(a)},f=function(){var a=$("#layout").layout({livePaneResizing:!0,north__paneSelector:"#navbar-container",center__paneSelector:"#doc-tty-container",east__paneSelector:"#code-container",south__paneSelector:"#footer-container",east__size:"50%",spacing_open:2,north__resizable:!1,north__size:35,north__spacing_open:0,north__showOverflowOnHover:!0,south__resizable:!1,south__size:29,south__spacing_open:0}),b=a.panes.center.layout({livePaneResizing:!0,spacing_open:2,north__paneSelector:"#doc-container",center__paneSelector:"#tty",south__paneSelector:"#compile-opts-container",north__size:"25%",south__resizable:!1,south__size:28,south__spacing_open:0}),c=a.panes.east.layout({livePaneResizing:!0,spacing_open:2,north__paneSelector:"#editor-tabs-bar",center__paneSelector:"#code",south__paneSelector:"#code-south-bar",north__resizable:!1,north__size:30,north__spacing_open:0,south__resizable:!1,south__size:28,south__spacing_open:0});return{mainLayout:a,ttyLayout:b,codeLayout:c}},g=function(){c=new a("code",b.getInstance())};return{initLayout:f,startEditor:g,compileButtonClicked:d,setEditorTheme:e}}(LiveEdit,SysRuntime),$(document).ready(function(){compileMain.initLayout(),compileMain.startEditor()});